name: Django CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write


jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports: [5432:5432]
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v3
        with:
          ref: SCRUM-65-Have-CICD-automatically-track-changes-bugs

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-django

      - name: Run migrations
        run: |
          cd backend
          python manage.py migrate
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db

      - name: Run tests with JUnit output
        run: |
          cd backend
          pytest --junitxml=test_results.xml
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db

      - name: Parse and append test results
        run: |
          cd backend
          python ../cicd_scripts/parse_test_results.py test_results.xml ../docs/test_results.md
          python ../cicd_scripts/parse_test_failures.py test_results.xml ../docs/bugs.md

      - name: Commit and push test docs
        run: |
         git config user.name "github-actions[bot]"
         git config user.email "github-actions[bot]@users.noreply.github.com"
         git add docs/test_results.md docs/bugs.md
         git commit -m "Update test results and bug tracking from CI run" || echo "No changes to commit"
         git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:SCRUM-65-Have-CICD-automatically-track-changes-bugs

